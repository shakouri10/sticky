const stickers = [
                    {
                      "name": "Sticker_1",
                      "address": "stickers/sticker1.png",
                      "size": [
                          {
                              "widthCm": "3",
                              "heightCm": "3.5"
                          },
                          {
                              "widthCm": "6",
                              "heightCm": "6.5"
                          }
                      ],
                      "categories": [
                          "\u0645\u0648\u0633\u06cc\u0642\u06cc",
                          "\u0633\u0631\u06af\u0631\u0645\u06cc"
                      ],
                      "isSaved": false,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_2",
                      "address": "stickers/sticker2.png",
                      "size": [
                          {
                              "widthCm": "2.5",
                              "heightCm": "2.4"
                          },
                          {
                              "widthCm": "4.5",
                              "heightCm": "4.3"
                          }
                      ],
                      "categories": [
                          "\u0647\u0646\u0631",
                          "\u0641\u0631\u0647\u0646\u06af"
                      ],
                      "isSaved": false,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_3",
                      "address": "stickers/sticker3.png",
                      "size": [
                          {
                              "widthCm": "5",
                              "heightCm": "4"
                          },
                          {
                              "widthCm": "8",
                              "heightCm": "7"
                          }
                      ],
                      "categories": [
                          "\u0648\u0631\u0632\u0634",
                          "\u062a\u0646\u0627\u0633\u0628 \u0627\u0646\u062f\u0627\u0645"
                      ],
                      "isSaved": false,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_4",
                      "address": "stickers/sticker4.png",
                      "size": [
                          {
                              "widthCm": "3",
                              "heightCm": "4"
                          },
                          {
                              "widthCm": "7",
                              "heightCm": "8"
                          }
                      ],
                      "categories": [
                          "\u0647\u0646\u0631",
                          "\u0641\u0631\u0647\u0646\u06af"
                      ],
                      "isSaved": false,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_5",
                      "address": "stickers/sticker5.png",
                      "size": [
                          {
                              "widthCm": "5",
                              "heightCm": "4"
                          },
                          {
                              "widthCm": "8",
                              "heightCm": "7"
                          }
                      ],
                      "categories": [
                          "\u0641\u0636\u0627",
                          "\u0639\u0644\u0645"
                      ],
                      "isSaved": true,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_6",
                      "address": "stickers/sticker6.png",
                      "size": [
                          {
                              "widthCm": "2",
                              "heightCm": "3.5"
                          },
                          {
                              "widthCm": "4",
                              "heightCm": "7"
                          }
                      ],
                      "categories": [
                          "\u0637\u0628\u06cc\u0639\u062a",
                          "\u062d\u06cc\u0648\u0627\u0646\u0627\u062a"
                      ],
                      "isSaved": true,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_7",
                      "address": "stickers/sticker7.png",
                      "size": [
                          {
                              "widthCm": "6",
                              "heightCm": "3.5"
                          },
                          {
                              "widthCm": "8",
                              "heightCm": "5"
                          }
                      ],
                      "categories": [
                          "\u0645\u0648\u0633\u06cc\u0642\u06cc",
                          "\u0633\u0631\u06af\u0631\u0645\u06cc"
                      ],
                      "isSaved": false,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_8",
                      "address": "stickers/sticker8.png",
                      "size": [
                          {
                              "widthCm": "5",
                              "heightCm": "4"
                          },
                          {
                              "widthCm": "8",
                              "heightCm": "7"
                          }
                      ],
                      "categories": [
                          "\u0637\u0628\u06cc\u0639\u062a",
                          "\u062d\u06cc\u0648\u0627\u0646\u0627\u062a"
                      ],
                      "isSaved": true,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_9",
                      "address": "stickers/sticker9.png",
                      "size": [
                          {
                              "widthCm": "3",
                              "heightCm": "2.5"
                          },
                          {
                              "widthCm": "6",
                              "heightCm": "5.5"
                          }
                      ],
                      "categories": [
                          "\u0645\u0648\u0633\u06cc\u0642\u06cc",
                          "\u0633\u0631\u06af\u0631\u0645\u06cc"
                      ],
                      "isSaved": true,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_10",
                      "address": "stickers/sticker10.png",
                      "size": [
                          {
                              "widthCm": "4",
                              "heightCm": "3.7"
                          },
                          {
                              "widthCm": "8",
                              "heightCm": "7.7"
                          }
                      ],
                      "categories": [
                          "\u0641\u0636\u0627",
                          "\u0639\u0644\u0645"
                      ],
                      "isSaved": true,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_11",
                      "address": "stickers/sticker11.png",
                      "size": [
                          {
                              "widthCm": "3.5",
                              "heightCm": "4"
                          },
                          {
                              "widthCm": "7.5",
                              "heightCm": "8"
                          }
                      ],
                      "categories": [
                          "\u0641\u0636\u0627",
                          "\u0639\u0644\u0645"
                      ],
                      "isSaved": false,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_12",
                      "address": "stickers/sticker12.png",
                      "size": [
                          {
                              "widthCm": "4",
                              "heightCm": "4"
                          },
                          {
                              "widthCm": "8",
                              "heightCm": "8"
                          }
                      ],
                      "categories": [
                          "\u0641\u0636\u0627",
                          "\u0639\u0644\u0645"
                      ],
                      "isSaved": true,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_13",
                      "address": "stickers/sticker13.png",
                      "size": [
                          {
                              "widthCm": "3.5",
                              "heightCm": "4"
                          },
                          {
                              "widthCm": "7",
                              "heightCm": "8"
                          }
                      ],
                      "categories": [
                          "\u0637\u0628\u06cc\u0639\u062a",
                          "\u062d\u06cc\u0648\u0627\u0646\u0627\u062a"
                      ],
                      "isSaved": false,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_14",
                      "address": "stickers/sticker14.png",
                      "size": [
                          {
                              "widthCm": "6",
                              "heightCm": "3.7"
                          }
                      ],
                      "categories": [
                          "\u0647\u0646\u0631",
                          "\u0641\u0631\u0647\u0646\u06af"
                      ],
                      "isSaved": true,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_15",
                      "address": "stickers/sticker15.png",
                      "size": [
                          {
                              "widthCm": "5",
                              "heightCm": "2"
                          }
                      ],
                      "categories": [
                          "\u0645\u0648\u0633\u06cc\u0642\u06cc",
                          "\u0633\u0631\u06af\u0631\u0645\u06cc"
                      ],
                      "isSaved": false,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_16",
                      "address": "stickers/sticker16.png",
                      "size": [
                          {
                              "widthCm": "8.7",
                              "heightCm": "9"
                          }
                      ],
                      "categories": [
                          "\u0641\u0636\u0627",
                          "\u0639\u0644\u0645"
                      ],
                      "isSaved": true,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_17",
                      "address": "stickers/sticker17.png",
                      "size": [
                          {
                              "widthCm": "2.5",
                              "heightCm": "5"
                          }
                      ],
                      "categories": [
                          "\u0645\u0648\u0633\u06cc\u0642\u06cc",
                          "\u0633\u0631\u06af\u0631\u0645\u06cc"
                      ],
                      "isSaved": false,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_18",
                      "address": "stickers/sticker18.png",
                      "size": [
                          {
                              "widthCm": "6",
                              "heightCm": "5"
                          }
                      ],
                      "categories": [
                          "\u0641\u0636\u0627",
                          "\u0639\u0644\u0645"
                      ],
                      "isSaved": false,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_19",
                      "address": "stickers/sticker19.png",
                      "size": [
                          {
                              "widthCm": "5",
                              "heightCm": "6"
                          }
                      ],
                      "categories": [
                          "\u0637\u0628\u06cc\u0639\u062a",
                          "\u062d\u06cc\u0648\u0627\u0646\u0627\u062a"
                      ],
                      "isSaved": false,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_20",
                      "address": "stickers/sticker20.png",
                      "size": [
                          {
                              "widthCm": "6",
                              "heightCm": "7"
                          }
                      ],
                      "categories": [
                          "\u0634\u0647\u0631\u0647\u0627",
                          "\u0645\u0639\u0645\u0627\u0631\u06cc"
                      ],
                      "isSaved": true,
                      "isPopular": false
                  },
                  {
                      "name": "Sticker_21",
                      "address": "stickers/sticker21.png",
                      "size": [
                          {
                              "widthCm": "5",
                              "heightCm": "4.5"
                          }
                      ],
                      "categories": [
                          "\u0648\u0631\u0632\u0634",
                          "\u062a\u0646\u0627\u0633\u0628 \u0627\u0646\u062f\u0627\u0645"
                      ],
                      "isSaved": true,
                      "isPopular": true
                  },
                  {
                      "name": "Sticker_22",
                      "address": "stickers/sticker22.png",
                      "size": [
                          {
                              "widthCm": "6",
                              "heightCm": "9"
                          }
                      ],
                      "categories": [
                          "\u0641\u0636\u0627",
                          "\u0639\u0644\u0645"
                      ],
                      "isSaved": true,
                      "isPopular": true
                  }
];

const devices = [
  {
    type: "mobile",
    models: [
      {
        name: "iPhone_13",
        address: "devices/iphone13.png",
        widthCm: "7.1628",
        heightCm: "14.6812"
      },
      // Add more mobile models here
    ]
  },
  {
    type: "laptop",
    models: [
      {
        name: "MacBook_Pro_16\"",
        address: "devices/macbookpro16.png",
        widthCm: "35.7886",
        heightCm: "24.5872"
      },
      {
        name: "MacBook_Pro_13\"",
        address: "devices/macbookpro13.png",
        widthCm: "30.4038",
        heightCm: "21.2344"
      },
      {
        name: "MacBook_Pro_14\"",
        address: "devices/macbookpro14.png",
        widthCm: "31.2674",
        heightCm: "22.1234"
      },

      // Add more laptop models here
    ]
  },
  // Add other device types as needed
];

let firstS = true;

document.addEventListener('DOMContentLoaded', () => {
  showDescriptionModal();
  setupDragDrop();
  populateInitialOptions(); // Updated to use the new initial setup
  setupDeviceOptions();
});

function setupDeviceModalClose() {
  const deviceModal = document.getElementById("deviceModal");

  // Add click event listener to the modal
  deviceModal.addEventListener('click', function(event) {
    // Check if the clicked element is the modal itself and not its child elements
    if (event.target === deviceModal) {
      closeModal();
    }
  });
}

function populateInitialOptions() {
  const sidebar = document.getElementById('stickerOptions');
  sidebar.innerHTML = '';

  const options = ['ذخیره شدها', 'جدیدترین', 'دسته‌بندی‌ها'];
  options.forEach(option => {
    const button = document.createElement('button');
    button.className = ' Categories'; // Updated classes
    button.textContent = option;
    button.onclick = () => {
      setActiveButton(button); // Set this button as active
      clearAndShowLoadingIndicator();
      setTimeout(() => {
        switch(option) {
          case 'ذخیره شدها':
            displaySavedStickers();
            break;
          case 'جدیدترین':
            displayPopularStickers();
            break;
          case 'دسته‌بندی‌ها':
            displayCategories();
            break;
        }
      }, 500);
    };
    sidebar.appendChild(button);
  });

  // Automatically click the first button to set it as active and display its content
  sidebar.firstChild.click();
}

function setActiveButton(selectedButton) {
  const buttons = document.querySelectorAll('#stickerOptions button');
  buttons.forEach(button => {
    button.classList.remove('active'); // Remove active class from all buttons
  });
  selectedButton.classList.add('active'); // Add active class to the clicked button
}

function showLoadingInSidebar() {
  const sidebar = document.getElementById('stickerSidebar');
  sidebar.innerHTML = '<div class="loading">Loading...</div>'; // Clear and show loading
}

function clearAndShowLoadingIndicator() {
  console.log(document.getElementById('stickerSidebar')); // Check if the element is correctly referenced
  const stickerList = document.getElementById('stickerSidebar');
  
  stickerList.innerHTML = '<div class="loading">Loading...</div>'; // Insert loading indicator HTML
  setTimeout(() => {
      stickerList.innerHTML = ''; // Clear loading indicator after 0.5 seconds
  }, 500);
}

function displayCategories() {
  const sidebar = document.getElementById('stickerSidebar');
  sidebar.innerHTML = ''; // Clear existing sidebar content
  sidebar.style.display = 'block'
  const uniqueCategories = getUniqueCategories();
  
  uniqueCategories.forEach(category => {
      const categoryButton = document.createElement('button');
      categoryButton.className = 'btn-cats'
      categoryButton.textContent = category;
      categoryButton.onclick = () => {
        clearAndShowLoadingIndicator()
          setTimeout(() => displayStickersByCategory(category), 500);
      };
      sidebar.appendChild(categoryButton);
  });
}

function showDescriptionModal() {
  const descriptionModal = document.getElementById("descriptionModal");
  descriptionModal.style.display = "block";

  const understandButton = document.getElementById("understandButton");
  understandButton.onclick = () => {
    descriptionModal.style.display = "none";
    openDeviceModal();
  };
}

function openDeviceModal() {
  const deviceModal = document.getElementById("deviceModal");
  deviceModal.style.display = "block";
}

function closeModal() {
  const modal = document.getElementById("deviceModal");
  modal.style.display = "none";
}

function populateStickers() {
  const stickers = document.querySelector('.stickers');
  for (let i = 1; i <= 12; i++) {
      const sticker = document.createElement('div');
      sticker.className = 'sticker drag-drop';
      sticker.style.backgroundImage = `url('stickers/sticker${i}.png')`;
      stickers.appendChild(sticker);
  }
}

function setupDeviceOptions() {
  const btnMobile = document.getElementById('btnMobile');
  const btnLaptop = document.getElementById('btnLaptop');
  const deviceSelection = document.getElementById('deviceSelection');

  btnMobile.addEventListener('click', () => {
    deviceSelection.innerHTML = generateDeviceOptions('mobile');
  });

  btnLaptop.addEventListener('click', () => {
    deviceSelection.innerHTML = generateDeviceOptions('laptop');
  });
}

function generateDeviceOptions(deviceType) {
  let optionsHtml = '';
  const filteredDevices = devices.filter(device => device.type === deviceType);
  
  if (filteredDevices.length > 0) {
    filteredDevices[0].models.forEach((model) => {
      optionsHtml += deviceOptionHTML(model.address, model.name, model.widthCm, model.heightCm);
    });
  }

  return optionsHtml;
}

function deviceOptionHTML(image, name, widthCm, heightCm) {
  return `
      <div class="device-option" onclick="selectDevice('${image}', '${widthCm}', '${heightCm}')">
          <img src='${image}' alt='${name}'>
          <p>${name}</p>
      </div>`;
}

function selectDevice(deviceImage, widthCm, heightCm) {
  const listSticker = document.getElementById('listSticker');
  listSticker.innerHTML = ''
  
  const dropzone = document.createElement('div');
  dropzone.id = 'Showdevices'
  dropzone.className = 'dropzone'

  listSticker.appendChild(dropzone)

  const { width, height } = calculateImageSize(widthCm, heightCm);
  
  dropzone.innerHTML = `<img src='${deviceImage}' alt='Device' style='width: ${width}px; height: ${height}px;'>`;

  closeModal();
}

function calculateImageSize(widthCm, heightCm) {
  // Conversion factor: Adjust based on your display requirements
  const pixelPerCm = 30;

  let width = widthCm * pixelPerCm;
  let height = heightCm * pixelPerCm;

  return { width, height };
}

function calculateStickerSize(widthCm, heightCm) {
  // Example conversion factor: 10 pixels per cm
  const pixelPerCm = 30;
  let width = widthCm * pixelPerCm;
  let height = heightCm * pixelPerCm;
  return { width, height };
}

function anotherDevice() {
  const modal = document.getElementById("deviceModal");
  modal.style.display = "block";
  const modal_child = document.getElementById("deviceModal_child");

  const close = document.createElement('div')
  close.innerHTML = "X"
  close.onclick = () => {
    closeModal()
  };
  close.style.position = 'absolute'
  close.style.cursor = 'pointer'
  close.style.top = '10px'
  close.style.left = '10px'

  modal_child.appendChild(close)
}

// Function to show size selection for a specific sticker
function showSizeOptionsForSticker(sticker, stickerItem) {
  // Create an overlay div inside the sticker item
  const sizeSelectionDiv = document.createElement('div');
  sizeSelectionDiv.className = 'size-selection';
  sizeSelectionDiv.style.position = 'absolute';
  sizeSelectionDiv.style.top = '0';
  sizeSelectionDiv.style.left = '0';
  sizeSelectionDiv.style.width = '100%';
  sizeSelectionDiv.style.height = '100%';
  sizeSelectionDiv.style.display = 'flex';
  sizeSelectionDiv.style.flexDirection = 'column';
  sizeSelectionDiv.style.alignItems = 'center';
  sizeSelectionDiv.style.justifyContent = 'center';
  sizeSelectionDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
  sizeSelectionDiv.style.zIndex = '10';

  // Add text to prompt user for size selection
  const promptText = document.createElement('span');
  promptText.innerText = 'انتخاب سایز:';
  promptText.style.margin = '5px';
  promptText.style.fontSize = '11px';

  sizeSelectionDiv.appendChild(promptText);

  // Add buttons for each size option
  sticker.size.forEach((size) => {
    const sizeBtn = document.createElement('button');
    sizeBtn.innerText = `${size.widthCm}cm x ${size.heightCm}cm`;
    sizeBtn.className = 'size-btn';
    sizeBtn.onclick = () => {
      addStickerToDropzone(sticker, size);
      stickerItem.removeChild(sizeSelectionDiv); // Remove the size selection div
    };
    sizeSelectionDiv.appendChild(sizeBtn);
  });

  // Append the size selection div to the sticker item
  stickerItem.appendChild(sizeSelectionDiv);
}

// Adjusted function to handle add button click
function addButtonClickHandler(sticker, wrapSticker) {
  return () => showSizeOptionsForSticker(sticker, wrapSticker);
}

// Updated to attach the modified click handler
function populateStickerSidebar(stickers) {
  const stickerList = document.getElementById('stickerSidebar');
  stickers.forEach((sticker) => {
    const wrapSticker = document.createElement('div');
    wrapSticker.className = 'wrap-sticker';

    const stickerImg = document.createElement('img');
    stickerImg.src = sticker.address;
    stickerImg.className = 'sticker-preview';
    stickerImg.alt = sticker.name;

    const addButton = document.createElement('button');
    addButton.innerText = '+';
    addButton.className = 'add-sticker-btn';
    addButton.onclick = addButtonClickHandler(sticker, wrapSticker); // Pass wrapSticker

    wrapSticker.appendChild(stickerImg);
    wrapSticker.appendChild(addButton);
    stickerList.appendChild(wrapSticker);
  });
}

function populateStickerOptions() {
  const stickerOptions = document.getElementById('stickerOptions'); // Assume this is a new div in your sidebar

  // Option 1: Saved Stickers
  const savedStickersBtn = document.createElement('button');
  savedStickersBtn.innerText = 'استیکرهای ذخیره شده';
  savedStickersBtn.onclick = () => displaySavedStickers();
  stickerOptions.appendChild(savedStickersBtn);

  // Option 2: Stickers by Category
  const categorySelect = document.createElement('select');
  // Assuming you have a function to get unique categories from stickers
  const categories = getUniqueCategories(); 
  categories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.innerText = category;
    categorySelect.appendChild(option);
  });
  categorySelect.onchange = () => displayStickersByCategory(categorySelect.value);
  stickerOptions.appendChild(categorySelect);

  // Option 3: Popular Stickers
  const popularStickersBtn = document.createElement('button');
  popularStickersBtn.innerText = 'استیکرهای محبوب';
  popularStickersBtn.onclick = () => displayPopularStickers();
  stickerOptions.appendChild(popularStickersBtn);
}

// Implement the functions to display saved, category-specific, and popular stickers
function displaySavedStickers() {
  const sidebar = document.getElementById('stickerSidebar');
  sidebar.style.display = 'flex'
  const savedStickers = stickers.filter(sticker => sticker.isSaved);
  populateStickerSidebar(savedStickers);
}

function displayStickersByCategory(category) {
  const sidebar = document.getElementById('stickerSidebar');
  sidebar.style.display = 'flex'
  const categoryStickers = stickers.filter(sticker => sticker.categories.includes(category));
  populateStickerSidebar(categoryStickers);
}

function displayPopularStickers() {
  const sidebar = document.getElementById('stickerSidebar');
  sidebar.style.display = 'flex'
  const popularStickers = stickers.filter(sticker => sticker.isPopular);
  populateStickerSidebar(popularStickers);
}

// Adjusted function to handle add button click and show size options directly
function addButtonClickHandler(sticker, wrapSticker) {
  return () => {
    // Check if a size selection overlay already exists and remove it
    const existingOverlay = document.querySelector('.size-selection');
    if (existingOverlay) {
      existingOverlay.parentNode.removeChild(existingOverlay);
    }
    
    // Create and show size selection overlay
    const overlay = document.createElement('div');
    overlay.className = 'size-selection-overlay';
    
    // Populate overlay with size options
    sticker.size.forEach(size => {
      const sizeOption = document.createElement('button');
      sizeOption.className ='size-btn'
      sizeOption.innerText = `${size.widthCm}cm x ${size.heightCm}cm`;
      sizeOption.onclick = () => {
        addStickerToDropzone(sticker, size);
        wrapSticker.removeChild(overlay);
      };
      overlay.appendChild(sizeOption);
    });

    wrapSticker.style.position = 'relative';
    wrapSticker.appendChild(overlay);
  };
}

function getUniqueCategories() {
  const categories = new Set(stickers.flatMap(sticker => sticker.categories));
  return [...categories];
}

function promptStickerSizeSelection(sticker) {
  // Generate a message string with size options
  let sizeOptionsString = sticker.size.map((size, index) => `${index + 1}: ${size.widthCm}cm x ${size.heightCm}cm`).join('\n');
  let userChoice = window.prompt(`Choose a size for ${sticker.name}:\n${sizeOptionsString}\nEnter number:`);
  let selectedIndex = parseInt(userChoice, 10) - 1;

  // Validate user choice and call addStickerToDropzone with selected size
  if (!isNaN(selectedIndex) && selectedIndex >= 0 && selectedIndex < sticker.size.length) {
      addStickerToDropzone(sticker, sticker.size[selectedIndex]);
  } else {
      alert("Invalid choice. Please try again.");
  }
}

function showDeleteConfirmationModal(sticker) {
  const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
  deleteConfirmationModal.style.display = 'block';

  // Find buttons within the modal
  const confirmDeleteButton = document.getElementById('confirmDeleteButton');
  const cancelDeleteButton = document.getElementById('cancelDeleteButton');

  // Temporarily store click handlers to remove them later
  const confirmClickHandler = () => {
      sticker.remove(); // Remove the sticker
      deleteConfirmationModal.style.display = 'none'; // Hide the modal
      // Clean up event listeners
      confirmDeleteButton.removeEventListener('click', confirmClickHandler);
      cancelDeleteButton.removeEventListener('click', cancelClickHandler);
  };

  const cancelClickHandler = () => {
      deleteConfirmationModal.style.display = 'none'; // Simply hide the modal
      // Clean up event listeners
      confirmDeleteButton.removeEventListener('click', confirmClickHandler);
      cancelDeleteButton.removeEventListener('click', cancelClickHandler);
  };

  // Attach event listeners
  confirmDeleteButton.addEventListener('click', confirmClickHandler);
  cancelDeleteButton.addEventListener('click', cancelClickHandler);
}


function addStickerToDropzone(sticker, selectedSize) {
  const stickerDiv = document.createElement('div');
  stickerDiv.className = 'sticker drag-drop';
  stickerDiv.style.backgroundImage = `url('${sticker.address}')`;
  stickerDiv.setAttribute('data-rotation', '0');
  stickerDiv.setAttribute('data-x', '0'); // Initial translation X
  stickerDiv.setAttribute('data-y', '0'); // Initial translation Y
  // stickerDiv.onclick = (event) => toggleRotationMode(event.currentTarget);
  stickerDiv.addEventListener('click', () => {
    // Check if this sticker is already active
    if (stickerDiv.classList.contains('active')) {
      // It's already active, so deactivate it
      stickerDiv.classList.remove('active');
      hideRotationControl(); // Hide the rotation control
    } else {
      // Make this sticker active and show the rotation control
      makeStickerActive(stickerDiv);
      toggleRotationMode(stickerDiv)
    }
  });

  const { width, height } = calculateStickerSize(selectedSize.widthCm, selectedSize.heightCm);
  stickerDiv.style.width = `${width}px`;
  stickerDiv.style.height = `${height}px`;

  // Create and append the remove button
  const removeButton = document.createElement('button');
  removeButton.innerText = 'حذف';
  removeButton.className = 'remove-sticker-btn';
  removeButton.style.display = 'none'; // Initially hide the button
  // removeButton.onclick = () => stickerDiv.remove();
  removeButton.onclick = () => {
    // Show the confirmation modal instead of directly removing
    showDeleteConfirmationModal(stickerDiv);
};

  stickerDiv.appendChild(removeButton);

  // Show the remove button on hover
  stickerDiv.onmouseenter = () => removeButton.style.display = 'block';
  stickerDiv.onmouseleave = () => removeButton.style.display = 'none';


  document.getElementById('listSticker').appendChild(stickerDiv);
  if(firstS){
    window.scrollBy(0, 200);
    firstS = false
  }
  setupDragDrop(); // Re-initialize drag and drop for the new sticker
}

function showRotationControl(sticker) {
  // Remove existing rotation controls to ensure only one is active
  document.querySelectorAll('.rotation-control').forEach(control => control.remove());
  let x = parseFloat(sticker.getAttribute('data-x')) || 0;
  let y = parseFloat(sticker.getAttribute('data-y')) || 0;

  // Create and append the rotation control
  const rotationControl = document.createElement('div');
  rotationControl.className = 'rotation-control';
  rotationControl.innerHTML = `
    <div class="rotation-line"></div>
    <div class="rotation-circle"></div>
  `;
  document.body.appendChild(rotationControl);

  // Calculate position for the rotation control
  const stickerRect = sticker.getBoundingClientRect();
  rotationControl.style.top = `${stickerRect.bottom}px`; // 10px below the sticker
  rotationControl.style.left = `${stickerRect.left}px`;
  rotationControl.style.width = `${stickerRect.width}px`;

  // Draggable circle
  const circle = rotationControl.querySelector('.rotation-circle');
  circle.onmousedown = function(event) {
    event.preventDefault(); // prevent text selection
    
    const lineRect = rotationControl.getBoundingClientRect();
    const originX = event.clientX;

    // Function to move circle within line limits
    const moveAt = (clientX) => {
      let newLeft = clientX - lineRect.left - circle.offsetWidth / 2;

      // Confine to rotation line boundaries
      if (newLeft < 0) {
        newLeft = 0;
      }
      let rightEdge = rotationControl.offsetWidth - circle.offsetWidth;
      if (newLeft > rightEdge) {
        newLeft = rightEdge;
      }

      circle.style.left = newLeft + 'px';

      // Calculate rotation
      const rotationDegrees = ((newLeft / rightEdge) * 360) - 180; // Example: full left is -180deg, center is 0deg, full right is 180deg
      sticker.style.transform= `translate(${x}px, ${y}px) rotate(${rotationDegrees}deg)`;
      sticker.setAttribute('data-rotation', rotationDegrees.toString());

      // sticker.style.transform = `rotate(${rotationDegrees}deg)`;
    };

    const onMouseMove = (moveEvent) => {
      moveAt(moveEvent.clientX);
    };

    document.addEventListener('mousemove', onMouseMove);

    document.onmouseup = function() {
      document.removeEventListener('mousemove', onMouseMove);
      document.onmouseup = null;
    };
  };


  circle.ondragstart = function() {
    return false;
  };
}

let currentActiveSticker = null; // To keep track of the currently active sticker

function hideRotationControl() {
  const rotationControl = document.querySelector('.rotation-control');
  if (rotationControl) {
    rotationControl.remove(); // Remove the rotation control from the document
  }
}

function resetActiveSticker() {
  if (currentActiveSticker) {
    currentActiveSticker.classList.remove('active');
    hideRotationControl();
    currentActiveSticker = null;
  }
}

function makeStickerActive(sticker) {
  resetActiveSticker(); // Reset any previously active sticker
  currentActiveSticker = sticker; // Set the new active sticker
  currentActiveSticker.classList.add('active');
  showRotationControl(currentActiveSticker); // Show rotation control for the new active sticker

  // Hide rotation control after 1 second of inactivity
  
  // let timeS = setTimeout(() => {
  //   if (currentActiveSticker === sticker) { // Check if the sticker is still the active one
  //     hideRotationControl();
  //   }
  // }, 10000);
  // clearTimeout(timeS)
}

document.querySelectorAll('.sticker').forEach(sticker => {
  sticker.onclick = () => {
    makeStickerActive(sticker);
  };

  sticker.addEventListener('mouseenter', () => {
    if (currentActiveSticker !== sticker) {
      makeStickerActive(sticker);
    }
  });

  // Optional: if you want to hide the rotation control after drag-and-drop,
  // you need to integrate this with your drag-and-drop library's callbacks
});

function toggleRotationMode(stickerElement) {
  if (stickerElement.classList.contains('rotate-mode')) {
    stickerElement.classList.remove('rotate-mode');
    window.removeEventListener('keydown', stickerElement.rotationHandler);
    clearTimeout(stickerElement.rotationTimeout);
    hideRotationPopup();
  } else {
    stickerElement.classList.add('rotate-mode');
    stickerElement.rotationHandler = (event) => rotateSticker(event, stickerElement);
    window.addEventListener('keydown', stickerElement.rotationHandler);

    // Set a timeout to automatically disable rotation mode and show popup
    stickerElement.rotationTimeout = setTimeout(() => {
      stickerElement.classList.remove('rotate-mode');
      window.removeEventListener('keydown', stickerElement.rotationHandler);
    }, 2000); // 3 seconds timeout

    setTimeout(() => {
      if (stickerElement.classList.contains('rotate-mode')) {
        hideRotationPopup();
      }
    }, 3000); 
    // Show the popup after 2 seconds
    setTimeout(() => {
      if (stickerElement.classList.contains('rotate-mode')) {
        showRotationPopup();
      }
    }, 500); // 2 seconds timeout
  }
}

function rotateSticker(event, stickerElement) {
  let rotationDegree = parseInt(stickerElement.getAttribute('data-rotation'), 10);
  let x = parseFloat(stickerElement.getAttribute('data-x')) || 0;
  let y = parseFloat(stickerElement.getAttribute('data-y')) || 0;

  if (event.key === 'ArrowRight' || event.key === 'ArrowLeft') {
    if (event.key === 'ArrowRight') {
      rotationDegree += 10;
    } else {
      rotationDegree -= 10;
    }

    stickerElement.style.transform = `translate(${x}px, ${y}px) rotate(${rotationDegree}deg)`;
    stickerElement.setAttribute('data-rotation', rotationDegree.toString());

    // Reset the timeout each time an arrow key is pressed
    clearTimeout(stickerElement.rotationTimeout);
    stickerElement.rotationTimeout = setTimeout(() => {
      stickerElement.classList.remove('rotate-mode');
      window.removeEventListener('keydown', stickerElement.rotationHandler);
    }, 3000); // 3 seconds timeout
  }
}

function showRotationPopup() {
  document.getElementById('rotationPopup').classList.add('show');
}

function hideRotationPopup() {
  document.getElementById('rotationPopup').classList.remove('show');
}

function setupDragDrop() {
  interact('.drag-drop').draggable({
      // Enable inertial throwing
      inertia: true,
      // Keep the element within the area of its parent
      modifiers: [
        interact.modifiers.restrictRect({
          restriction: 'parent',
          endOnly: true
        })
      ],
      // Enable autoScroll
      autoScroll: true,
      listeners: {
        // Call this function on every dragmove event
        move: dragMoveListener
      }
    });
  
    function dragMoveListener(event) {
      var target = event.target;
      // Keep the dragged position in the data-x/data-y attributes
      var x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
      var y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
      targetRotation = parseInt(target.getAttribute('data-rotation'), 10);
      // Translate the element
      // target.style.transform = 'translate(' + x + 'px, ' + y + 'px)';
      target.style.transform = `translate(${x}px, ${y}px) rotate(${targetRotation}deg)`;
      // Update the position attributes
      // target.style.position = 'relative'
      showRotationControl(target)
      target.setAttribute('data-x', x);
      target.setAttribute('data-y', y);
    }
  
    // Enable dropping on the ".dropzone" elements
    interact('.dropzone').dropzone({
      // Only accept elements matching this CSS selector
      accept: '.draggable',
      // Require a 75% element overlap for a drop to be possible
      overlap: 0.45,
      listeners: {
        drop(event) {
          // When a drop happens, add the "dropped" class to the draggable element
          event.relatedTarget.classList.add('dropped');

        }
      },
    });
  }